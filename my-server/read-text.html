<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CodeGuessr Arena</title>
    <style>
        :root {
            --bg: #0b1020;
            --bg2: #141c35;
            --panel: #111933;
            --panel-2: #1a2648;
            --text: #e6ecff;
            --muted: #9fb0de;
            --accent: #4fd1c5;
            --accent-2: #22d3ee;
            --danger: #f43f5e;
            --ok: #22c55e;
            --line: #2d3c66;
            --cur: #2dd4bf;
            --shadow: 0 14px 40px rgba(0, 0, 0, 0.4);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "JetBrains Mono", Consolas, "Courier New", monospace;
            color: var(--text);
            background:
                radial-gradient(1200px 700px at 0% 0%, #243874 0%, transparent 55%),
                radial-gradient(1000px 600px at 100% 100%, #2f1d5e 0%, transparent 60%),
                linear-gradient(145deg, var(--bg), var(--bg2));
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .arena {
            width: min(1200px, 100%);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 18px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .top {
            padding: 16px 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
            background: linear-gradient(90deg, rgba(79, 209, 197, 0.1), rgba(245, 158, 11, 0.06));
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }

        .title {
            margin: 0;
            font-size: 26px;
            letter-spacing: 0.02em;
        }

        .sub {
            margin: 4px 0 0;
            color: var(--muted);
            font-size: 13px;
        }

        .meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .chip {
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(14, 23, 47, 0.7);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 13px;
            color: #d6e2ff;
        }

        .chip b { color: #fff; }

        .layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 14px;
            padding: 14px;
        }

        .panel {
            background: rgba(13, 22, 44, 0.78);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 12px;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        button {
            border: 1px solid #38508c;
            background: #1c2a52;
            color: #eaf0ff;
            border-radius: 9px;
            padding: 8px 12px;
            font: inherit;
            cursor: pointer;
            transition: 120ms ease;
        }

        button:hover { filter: brightness(1.12); }
        button:active { transform: translateY(1px); }

        .btn-primary {
            background: linear-gradient(180deg, #32c5b7, #22b8aa);
            color: #062b27;
            border-color: #5de1d5;
            font-weight: 700;
        }

        .status {
            margin: 0 0 10px;
            font-size: 14px;
            color: var(--muted);
            min-height: 18px;
        }

        .status.ok { color: #9cf5bf; }
        .status.bad { color: #ff9bb1; }

        .top-panel.hidden { display: none; }

        .line-view {
            white-space: pre-wrap;
            word-break: break-word;
            border: 1px solid #34497a;
            background: #0f1830;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            min-height: 42px;
        }

        .context-block {
            margin-top: 10px;
            border: 1px solid #3a5188;
            background: #131f3e;
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            overflow-x: auto; /* NEW: добавлен горизонтальный скролл */
            width: min(72vw, 560px);
            aspect-ratio: 1 / 1;
            max-height: 560px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: auto;
            margin-right: auto;
        }

        .context-block-content {
            min-width: max-content;
            line-height: 1.5;
            text-align: left;
            white-space: pre;
            font-variant-ligatures: none;
            margin: 0 auto;
        }

        .row-prefix {
            color: #89a2d9;
        }

        .current {
            background: var(--cur);
            color: #1f2937;
            border-radius: 3px;
            padding: 0 2px;
            min-width: 0.9ch;
            display: inline-block;
            text-align: center;
        }

        .tok-kw { color: #b794ff; font-weight: 700; }
        .tok-type { color: #7dd3fc; }
        .tok-num { color: #fca5a5; }
        .tok-str { color: #86efac; }
        .tok-com { color: #7f8db4; font-style: italic; }
        .tok-fn { color: #5eead4; }
        .tok-op { color: #c4b5fd; }

        .guess-title {
            margin: 0 0 8px;
            font-size: 15px;
            color: #d8e3ff;
        }

        .choices {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }

        .choices button {
            text-align: left;
            background: #162447;
            border-color: #324c84;
            font-size: 13px;
        }

        .choices button.correct {
            background: rgba(34, 197, 94, 0.18);
            border-color: rgba(34, 197, 94, 0.7);
        }

        .choices button.reveal {
            background: rgba(245, 158, 11, 0.25);
            border-color: rgba(245, 158, 11, 0.85);
            color: #ffe8b5;
            font-weight: 700;
        }

        .choices button.wrong {
            background: rgba(244, 63, 94, 0.2);
            border-color: rgba(244, 63, 94, 0.75);
        }

        .timer {
            border: 1px solid #4762a1;
            background: #16254a;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .timer-head {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #b6c6ef;
            margin-bottom: 6px;
        }

        .bar {
            height: 10px;
            background: #0e1833;
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid #334d86;
        }

        .bar > i {
            display: block;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            transition: width 180ms linear;
        }

        .answer {
            margin-top: 10px;
            font-size: 13px;
            color: #bfd0f8;
            min-height: 18px;
        }

        .leaderboard {
            margin-top: 12px;
            border-top: 1px solid #334d86;
            padding-top: 10px;
        }

        .leaderboard-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
        }

        .leaderboard-title {
            margin: 0;
            font-size: 14px;
            color: #d8e3ff;
        }

        .leaderboard select {
            background: #132348;
            color: #e6ecff;
            border: 1px solid #39558e;
            border-radius: 8px;
            font: inherit;
            padding: 6px 8px;
            min-width: 150px;
        }

        .leaderboard-list {
            border: 1px solid #345087;
            border-radius: 8px;
            overflow: hidden;
            background: #101b36;
        }

        .leaderboard-row {
            display: grid;
            grid-template-columns: 34px 1fr auto auto;
            gap: 8px;
            padding: 7px 8px;
            font-size: 12px;
            align-items: center;
            border-top: 1px solid rgba(112, 139, 197, 0.2);
        }

        .leaderboard-row:first-child {
            border-top: none;
            background: rgba(79, 209, 197, 0.08);
            color: #dff8f4;
            font-weight: 700;
        }

        .leaderboard-empty {
            padding: 10px;
            font-size: 12px;
            color: #9db1e3;
        }

        .leaderboard-clear {
            margin-top: 8px;
            width: 100%;
            font-size: 12px;
            padding: 6px 8px;
            border-color: #6b3050;
            background: #2c1430;
            color: #ffd9e6;
        }

        .kbd {
            border: 1px solid #4e6498;
            border-bottom-width: 2px;
            border-radius: 6px;
            padding: 0 6px;
            background: #12203f;
            font-size: 12px;
            color: #d0ddfd;
        }

        @media (max-width: 980px) {
            .layout { grid-template-columns: 1fr; }
            .choices { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

        @media (max-width: 640px) {
            body { padding: 10px; }
            .title { font-size: 22px; }
            .choices { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
    </style>
</head>
<body>
    <main class="arena">
        <section class="top">
            <div>
                <h1 class="title">CodeGuessr Arena</h1>
                <p class="sub">Определи язык как можно быстрее. Навигация: <span class="kbd">←</span><span class="kbd">→</span><span class="kbd">↑</span><span class="kbd">↓</span>, новый раунд: <span class="kbd">N</span>, размер окна: <span class="kbd">Shift+↑</span> / <span class="kbd">Shift+↓</span></p>
            </div>
            <div class="meta">
                <span class="chip">Раунд: <b id="roundChip">0</b></span>
                <span class="chip">Очки: <b id="scoreChip">0</b></span>
                <span class="chip">Серия: <b id="streakChip">0</b></span>
            </div>
        </section>

        <section class="layout">
            <section class="panel">
                <div class="toolbar">
                    <button id="newSampleBtn" class="btn-primary" type="button">Новый раунд</button>
                    <button id="toggleTopPanelBtn" type="button">Debug off</button>
                </div>
                <p id="status" class="status">Загрузка...</p>

                <div id="topPanel" class="top-panel hidden">
                    <div id="linePanel" class="line-view">
                        <div id="line"></div>
                    </div>
                </div>

                <div id="contextBlock" class="context-block"></div>
            </section>

            <aside class="panel">
                <div class="timer">
                    <div class="timer-head">
                        <span>Осталось времени</span>
                        <strong id="timerLabel">0 c</strong>
                    </div>
                    <div class="bar"><i id="timerFill"></i></div>
                </div>

                <p class="guess-title">Выбери язык:</p>
                <div id="choices" class="choices"></div>
                <div id="answer" class="answer"></div>

                <div class="leaderboard">
                    <div class="leaderboard-head">
                        <p class="leaderboard-title">Лидеры по языку</p>
                        <select id="leaderboardLanguage"></select>
                    </div>
                    <div id="leaderboardList" class="leaderboard-list"></div>
                    <button id="clearLeaderboardBtn" class="leaderboard-clear" type="button">Очистить таблицу</button>
                </div>
            </aside>
        </section>
    </main>

    <script>
        // NEW: убраны глобальные константы размеров, они перенесены в state
        const FLASHLIGHT_HEIGHT = 11;  // больше не используется
        const HORIZONTAL_RADIUS = 14;  // не используется
        const VERTICAL_RADIUS = Math.floor(FLASHLIGHT_HEIGHT / 2); // не используется
        const FLASHLIGHT_WIDTH = HORIZONTAL_RADIUS * 2 + 1; // не используется

        const ROUND_SECONDS = 25;
        const MAX_ATTEMPTS = 3;
        const LEADERBOARD_KEY = 'codeguessr_leaderboard_v1';
        const LANGUAGE_OPTIONS = [
            'JavaScript', 'TypeScript', 'Python', 'Ruby', 'Java', 'Kotlin',
            'C#', 'C', 'C++', 'PHP', 'Rust', 'Swift', 'Go', 'Lua',
            'Haskell', 'Scala', 'Dart', 'Elixir', 'Clojure', 'OCaml', 'Groovy', 'Julia', 'Nim', 'Zig'
        ];

        const KEYWORDS = new Set([
            'if', 'else', 'for', 'while', 'return', 'class', 'def', 'fn', 'function', 'const', 'let', 'var',
            'public', 'private', 'protected', 'static', 'new', 'try', 'catch', 'finally', 'switch', 'case',
            'break', 'continue', 'enum', 'struct', 'interface', 'extends', 'implements', 'async', 'await',
            'lambda', 'match', 'where', 'trait', 'impl', 'module', 'include', 'template', 'typename', 'import',
            'from', 'package', 'using', 'namespace', 'do', 'then', 'end', 'elsif', 'yield', 'throw', 'throws'
        ]);

        const TYPES = new Set([
            'int', 'float', 'double', 'string', 'bool', 'boolean', 'char', 'long', 'short', 'byte', 'void',
            'usize', 'isize', 'u8', 'u16', 'u32', 'u64', 'i8', 'i16', 'i32', 'i64', 'Vec', 'Option', 'Result',
            'List', 'Map', 'Set', 'Dictionary'
        ]);

        const state = {
            lines: [],
            line: 0,
            col: 0,
            preferredCol: 0,
            language: 'Unknown',
            score: 0,
            streak: 0,
            round: 0,
            timeLeft: ROUND_SECONDS,
            timerId: null,
            roundActive: false,
            topVisible: false,
            leaderboard: {},
            leaderboardLanguage: 'JavaScript',
            attemptsUsed: 0,
            // NEW: параметры размера окна
            horzRadius: 14,
            vertRadius: 5
        };

        const statusEl = document.getElementById('status');
        const topPanelEl = document.getElementById('topPanel');
        const lineEl = document.getElementById('line');
        const contextBlockEl = document.getElementById('contextBlock');
        const newSampleBtn = document.getElementById('newSampleBtn');
        const toggleTopPanelBtn = document.getElementById('toggleTopPanelBtn');
        const roundChipEl = document.getElementById('roundChip');
        const scoreChipEl = document.getElementById('scoreChip');
        const streakChipEl = document.getElementById('streakChip');
        const timerLabelEl = document.getElementById('timerLabel');
        const timerFillEl = document.getElementById('timerFill');
        const choicesEl = document.getElementById('choices');
        const answerEl = document.getElementById('answer');
        const leaderboardLanguageEl = document.getElementById('leaderboardLanguage');
        const leaderboardListEl = document.getElementById('leaderboardList');
        const clearLeaderboardBtn = document.getElementById('clearLeaderboardBtn');

        function escapeHtml(value) {
            return value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderCurrentChar(ch) {
            if (ch === ' ') return '&nbsp;';
            if (ch === '\t') return '&nbsp;&nbsp;&nbsp;&nbsp;';
            return escapeHtml(ch);
        }

        function tokenClass(type) {
            if (type === 'keyword') return 'tok-kw';
            if (type === 'type') return 'tok-type';
            if (type === 'number') return 'tok-num';
            if (type === 'string') return 'tok-str';
            if (type === 'comment') return 'tok-com';
            if (type === 'function') return 'tok-fn';
            if (type === 'operator') return 'tok-op';
            return '';
        }

        function isLetter(ch) {
            return /[A-Za-z_]/.test(ch);
        }

        function isDigit(ch) {
            return /[0-9]/.test(ch);
        }

        function tokenize(line) {
            const tokens = [];
            let i = 0;

            while (i < line.length) {
                const ch = line[i];
                const next2 = line.slice(i, i + 2);

                if (next2 === '//' || next2 === '--') {
                    tokens.push({ type: 'comment', text: line.slice(i), start: i, end: line.length });
                    break;
                }

                if (ch === '#') {
                    const language = state.language.toLowerCase();
                    const pythonStyleHashComment = language === 'python';
                    const prev = i > 0 ? line[i - 1] : ' ';
                    if (pythonStyleHashComment || /\s/.test(prev) || i === 0) {
                        tokens.push({ type: 'comment', text: line.slice(i), start: i, end: line.length });
                        break;
                    }
                }

                if (ch === '"' || ch === "'" || ch === '`') {
                    const quote = ch;
                    let j = i + 1;
                    while (j < line.length) {
                        if (line[j] === '\\') {
                            j += 2;
                            continue;
                        }
                        if (line[j] === quote) {
                            j += 1;
                            break;
                        }
                        j += 1;
                    }
                    tokens.push({ type: 'string', text: line.slice(i, j), start: i, end: j });
                    i = j;
                    continue;
                }

                if (isDigit(ch)) {
                    let j = i + 1;
                    while (j < line.length && /[0-9A-Fa-f_xX\.]/.test(line[j])) j += 1;
                    tokens.push({ type: 'number', text: line.slice(i, j), start: i, end: j });
                    i = j;
                    continue;
                }

                if (isLetter(ch) || ch === '$') {
                    let j = i + 1;
                    while (j < line.length && /[A-Za-z0-9_$]/.test(line[j])) j += 1;
                    const word = line.slice(i, j);
                    let type = 'plain';
                    if (KEYWORDS.has(word)) type = 'keyword';
                    else if (TYPES.has(word)) type = 'type';

                    let k = j;
                    while (k < line.length && /\s/.test(line[k])) k += 1;
                    if (line[k] === '(' && type === 'plain') type = 'function';

                    tokens.push({ type, text: word, start: i, end: j });
                    i = j;
                    continue;
                }

                if (/[+\-*\/%=!<>|&^~?:]/.test(ch)) {
                    let j = i + 1;
                    while (j < line.length && /[+\-*\/%=!<>|&^~?:]/.test(line[j])) j += 1;
                    tokens.push({ type: 'operator', text: line.slice(i, j), start: i, end: j });
                    i = j;
                    continue;
                }

                tokens.push({ type: 'plain', text: ch, start: i, end: i + 1 });
                i += 1;
            }

            return tokens;
        }

        function renderTokenText(text, type) {
            const cls = tokenClass(type);
            if (!cls) return escapeHtml(text);
            return `<span class="${cls}">${escapeHtml(text)}</span>`;
        }

        // NEW: функция buildFlashlightWindow теперь принимает радиус как аргумент
        function buildFlashlightWindow(line, centerCol, radius) {
            const width = radius * 2 + 1;
            let out = '';

            for (let i = 0; i < width; i += 1) {
                const absoluteCol = centerCol - radius + i;
                if (absoluteCol < 0 || absoluteCol >= line.length) {
                    out += ' ';
                } else {
                    out += line[absoluteCol];
                }
            }

            return out;
        }

        function renderHighlightedSegment(segment, focusIndex, forceCursor = false) {
            if (!segment) {
                return forceCursor ? '<span class="current">&nbsp;</span>' : '';
            }

            const tokens = tokenize(segment);
            let html = '';

            for (const token of tokens) {
                const inToken = focusIndex >= token.start && focusIndex < token.end;
                if (!inToken) {
                    html += renderTokenText(token.text, token.type);
                    continue;
                }

                const local = focusIndex - token.start;
                const before = token.text.slice(0, local);
                const cur = token.text[local] ?? ' ';
                const after = token.text.slice(local + 1);

                html += renderTokenText(before, token.type);
                const cls = tokenClass(token.type);
                const tokenClassTail = cls ? ` ${cls}` : '';
                html += `<span class="current${tokenClassTail}">${renderCurrentChar(cur)}</span>`;
                html += renderTokenText(after, token.type);
            }

            if (forceCursor && (focusIndex < 0 || focusIndex >= segment.length)) {
                html += '<span class="current">&nbsp;</span>';
            }
            return html;
        }

        function clampPosition() {
            if (state.lines.length === 0) {
                state.line = 0;
                state.col = 0;
                state.preferredCol = 0;
                return;
            }
            if (state.line < 0) state.line = 0;
            if (state.line > state.lines.length - 1) state.line = state.lines.length - 1;
            if (state.col < 0) state.col = 0;
        }

        function renderHud() {
            roundChipEl.textContent = String(state.round);
            scoreChipEl.textContent = String(state.score);
            streakChipEl.textContent = String(state.streak);
            timerLabelEl.textContent = `${state.timeLeft} c`;
            const percent = Math.max(0, Math.min(100, (state.timeLeft / ROUND_SECONDS) * 100));
            timerFillEl.style.width = `${percent}%`;
        }

        function emptyLeaderboard() {
            const board = {};
            for (const lang of LANGUAGE_OPTIONS) board[lang] = [];
            return board;
        }

        function loadLeaderboard() {
            try {
                const raw = localStorage.getItem(LEADERBOARD_KEY);
                const parsed = raw ? JSON.parse(raw) : {};
                const board = emptyLeaderboard();
                for (const lang of LANGUAGE_OPTIONS) {
                    const entries = Array.isArray(parsed[lang]) ? parsed[lang] : [];
                    board[lang] = entries
                        .filter(e => e && Number.isFinite(e.score) && Number.isFinite(e.timeLeft))
                        .map(e => ({
                            score: Math.floor(e.score),
                            timeLeft: Math.floor(e.timeLeft),
                            round: Number.isFinite(e.round) ? Math.floor(e.round) : 0,
                            at: Number.isFinite(e.at) ? e.at : Date.now()
                        }))
                        .sort((a, b) => b.score - a.score || b.timeLeft - a.timeLeft || a.at - b.at)
                        .slice(0, 10);
                }
                return board;
            } catch {
                return emptyLeaderboard();
            }
        }

        function saveLeaderboard() {
            localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(state.leaderboard));
        }

        function addLeaderboardEntry(language, score, timeLeft) {
            if (!state.leaderboard[language]) state.leaderboard[language] = [];
            state.leaderboard[language].push({
                score,
                timeLeft,
                round: state.round,
                at: Date.now()
            });
            state.leaderboard[language].sort((a, b) => b.score - a.score || b.timeLeft - a.timeLeft || a.at - b.at);
            state.leaderboard[language] = state.leaderboard[language].slice(0, 10);
            saveLeaderboard();
        }

        function renderLeaderboardSelector() {
            const langs = [...LANGUAGE_OPTIONS].sort((a, b) => a.localeCompare(b));
            leaderboardLanguageEl.innerHTML = langs
                .map(lang => `<option value="${escapeHtml(lang)}">${escapeHtml(lang)}</option>`)
                .join('');

            if (!langs.includes(state.leaderboardLanguage)) {
                state.leaderboardLanguage = langs[0] || 'JavaScript';
            }
            leaderboardLanguageEl.value = state.leaderboardLanguage;
        }

        function renderLeaderboardList() {
            const language = state.leaderboardLanguage;
            const items = state.leaderboard[language] || [];

            if (items.length === 0) {
                leaderboardListEl.innerHTML = '<div class="leaderboard-empty">Пока нет результатов для этого языка</div>';
                return;
            }

            const rows = items.map((entry, idx) => {
                const rank = idx + 1;
                const when = new Date(entry.at).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                return `<div class="leaderboard-row"><span>#${rank}</span><span>Раунд ${entry.round}</span><strong>${entry.score}</strong><span>${entry.timeLeft}с • ${when}</span></div>`;
            });
            leaderboardListEl.innerHTML = rows.join('');
        }

        function renderLeaderboard() {
            renderLeaderboardSelector();
            renderLeaderboardList();
        }

        function getChoiceButtons() {
            return choicesEl.querySelectorAll('button');
        }

        function clearChoiceHighlights() {
            for (const btn of getChoiceButtons()) {
                btn.classList.remove('correct', 'wrong', 'reveal');
            }
        }

        function updateDebugButtonLabel() {
            toggleTopPanelBtn.textContent = state.topVisible ? 'Debug on' : 'Debug off';
        }

        function renderChoices() {
            const options = Array.from(new Set([...LANGUAGE_OPTIONS, state.language])).sort((a, b) => a.localeCompare(b));
            choicesEl.innerHTML = options
                .map(lang => `<button data-lang="${escapeHtml(lang)}">${escapeHtml(lang)}</button>`)
                .join('');

            for (const btn of getChoiceButtons()) {
                btn.addEventListener('click', () => handleGuess(btn.getAttribute('data-lang') || ''));
            }
        }

        function renderStatus(text, type = '') {
            statusEl.textContent = text;
            statusEl.className = `status ${type}`.trim();
        }

        function renderCode() {
            clampPosition();

            if (state.lines.length === 0) {
                lineEl.innerHTML = '<span class="current">&nbsp;</span>';
                contextBlockEl.innerHTML = '<div class="context-block-content">∅</div>';
                return;
            }

            const currentLine = state.lines[state.line];
            const hasChars = state.col < currentLine.length;
            const colShown = state.col;

            if (hasChars) {
                lineEl.innerHTML = renderHighlightedSegment(currentLine, colShown, true);
            } else {
                lineEl.innerHTML = '<span class="current">&nbsp;</span>';
            }

            // NEW: используем state.vertRadius для определения вертикальных границ
            const top = Math.max(0, state.line - state.vertRadius);
            const bottom = Math.min(state.lines.length - 1, state.line + state.vertRadius);
            const rows = [];

            for (let row = top; row <= bottom; row += 1) {
                const rawLine = state.lines[row];
                const marker = row === state.line ? '>' : ' ';
                const rowNum = String(row + 1).padStart(4, ' ');
                const prefix = `${marker}${rowNum} | `;
                const suffix = ' '.repeat(prefix.length);
                // NEW: передаём текущий горизонтальный радиус
                const local = buildFlashlightWindow(rawLine, state.col, state.horzRadius);
                const localHtml = row === state.line
                    ? renderHighlightedSegment(local, state.horzRadius, true)
                    : renderHighlightedSegment(local, -1, false);
                rows.push(`<div><span class="row-prefix">${escapeHtml(prefix)}</span>${localHtml}${escapeHtml(suffix)}</div>`);
            }

            contextBlockEl.innerHTML =
                `<div class="context-block-content">${rows.join('')}</div>`;
        }

        function renderAll() {
            renderHud();
            renderCode();
        }

        function stopTimer() {
            if (state.timerId !== null) {
                clearInterval(state.timerId);
                state.timerId = null;
            }
        }

        function finishRound(correct, guessed, reason = '') {
            state.roundActive = false;
            stopTimer();

            if (correct) {
                const bonus = 100 + state.timeLeft * 6;
                state.score += bonus;
                state.streak += 1;
                addLeaderboardEntry(state.language, bonus, state.timeLeft);
                state.leaderboardLanguage = state.language;
                renderStatus(`Верно! +${bonus} очков`, 'ok');
                answerEl.textContent = `Ответ: ${state.language}`;
            } else {
                state.streak = 0;
                if (reason === 'attempts') {
                    renderStatus('3 попытки закончились. Раунд: 0 очков', 'bad');
                } else {
                    renderStatus('Время вышло. Раунд: 0 очков', 'bad');
                }
                answerEl.textContent = `Ответ: ${state.language} (0 очков)`;
            }

            clearChoiceHighlights();
            for (const btn of getChoiceButtons()) {
                const lang = btn.getAttribute('data-lang');
                if (lang === state.language) {
                    btn.classList.add(correct ? 'correct' : 'reveal');
                } else if (lang === guessed) {
                    btn.classList.add('wrong');
                }
            }

            renderHud();
            renderLeaderboard();
        }

        function startTimer() {
            stopTimer();
            state.timerId = setInterval(() => {
                if (!state.roundActive) return;
                state.timeLeft -= 1;
                if (state.timeLeft <= 0) {
                    state.timeLeft = 0;
                    renderHud();
                    finishRound(false, null, 'time');
                    return;
                }
                renderHud();
            }, 1000);
        }

        function handleGuess(lang) {
            if (!state.roundActive) return;

            if (lang === state.language) {
                finishRound(true, lang);
                return;
            }

            state.attemptsUsed += 1;
            const attemptsLeft = Math.max(0, MAX_ATTEMPTS - state.attemptsUsed);

            for (const btn of getChoiceButtons()) {
                const val = btn.getAttribute('data-lang');
                btn.classList.remove('wrong');
                if (val === lang) btn.classList.add('wrong');
            }

            if (state.attemptsUsed >= MAX_ATTEMPTS) {
                finishRound(false, lang, 'attempts');
                return;
            }

            renderStatus(`Нет, это не ${lang}. Осталось попыток: ${attemptsLeft}`, 'bad');
        }

        function moveLeft() {
            if (state.lines.length === 0) return;
            if (state.col > 0) {
                state.col -= 1;
                state.preferredCol = state.col;
            }
        }

        function moveRight() {
            if (state.lines.length === 0) return;
            state.col += 1;
            state.preferredCol = state.col;
        }

        function moveVertical(delta) {
            if (state.lines.length === 0) return;
            state.line += delta;
            clampPosition();
            state.col = state.preferredCol;
        }

        // NEW: изменение размера окна
        function changeFlashlightSize(deltaHorz, deltaVert) {
            const newHorz = state.horzRadius + deltaHorz;
            const newVert = state.vertRadius + deltaVert;
            if (newHorz < 1 || newHorz > 30 || newVert < 1 || newVert > 15) return; // разумные пределы
            state.horzRadius = newHorz;
            state.vertRadius = newVert;
            renderCode();
        }

        function setRandomStartPosition() {
            if (state.lines.length === 0) {
                state.line = 0;
                state.col = 0;
                state.preferredCol = 0;
                return;
            }
            state.line = Math.floor(Math.random() * state.lines.length);
            const lineLength = state.lines[state.line].length;
            state.col = lineLength > 0 ? Math.floor(Math.random() * lineLength) : 0;
            state.preferredCol = state.col;
        }

        function loadRandomCode() {
            stopTimer();
            renderStatus('Загрузка нового раунда...');
            answerEl.textContent = 'Ответ скрыт до конца раунда';

            fetch('/api/random-code')
                .then(response => {
                    if (!response.ok) throw new Error('Не удалось получить случайный код');
                    return response.json();
                })
                .then(payload => {
                    const text = typeof payload.code === 'string' ? payload.code : '';
                    state.language = typeof payload.language === 'string' ? payload.language : 'Unknown';
                    state.lines = text.split(/\r?\n/);
                    if (state.lines.length === 0) state.lines = [''];

                    state.round += 1;
                    state.timeLeft = ROUND_SECONDS;
                    state.roundActive = true;
                    state.attemptsUsed = 0;
                    setRandomStartPosition();

                    renderChoices();
                    renderStatus('Раунд начался. Выбери язык как можно быстрее.');
                    renderAll();
                    startTimer();
                })
                .catch(error => {
                    state.roundActive = false;
                    renderStatus(`Ошибка: ${error.message}`, 'bad');
                    lineEl.textContent = '';
                    contextBlockEl.textContent = '';
                    answerEl.textContent = '';
                });
        }

        newSampleBtn.addEventListener('click', loadRandomCode);

        leaderboardLanguageEl.addEventListener('change', () => {
            state.leaderboardLanguage = leaderboardLanguageEl.value;
            renderLeaderboardList();
        });

        clearLeaderboardBtn.addEventListener('click', () => {
            state.leaderboard = emptyLeaderboard();
            saveLeaderboard();
            renderLeaderboard();
        });

        toggleTopPanelBtn.addEventListener('click', () => {
            state.topVisible = !state.topVisible;
            topPanelEl.classList.toggle('hidden', !state.topVisible);
            updateDebugButtonLabel();
        });

        function handleGlobalKeyDown(event) {
            if (event.code === 'KeyN' || event.key.toLowerCase() === 'n') {
                event.preventDefault();
                loadRandomCode();
                return;
            }

            // NEW: обработка Shift+стрелки для изменения размера окна
            if (event.shiftKey) {
                if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    changeFlashlightSize(1, 1);
                    return;
                }
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    changeFlashlightSize(-1, -1);
                    return;
                }
            }

            const keys = ['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
            if (!keys.includes(event.key)) return;
            event.preventDefault();

            if (event.key === 'ArrowLeft') moveLeft();
            if (event.key === 'ArrowRight') moveRight();
            if (event.key === 'ArrowUp') moveVertical(-1);
            if (event.key === 'ArrowDown') moveVertical(1);
            renderCode();
        }
        window.addEventListener('keydown', handleGlobalKeyDown);

        state.leaderboard = loadLeaderboard();
        updateDebugButtonLabel();
        renderChoices();
        renderLeaderboard();
        renderAll();
        loadRandomCode();
    </script>
</body>
</html>